---
- name: Register existing settings
  hosts: local
  roles:
  - register_host
  vars:
    dnsname_or_ip: "{{ hostvars.bastion.ansible_host }}"
    group: "scn4_ecs"

- name: Configure cron on main host for stress testing
  become: true
  hosts: gatewayed
  tasks:

    - name: Install stress and cron package
      apt:
        name:  ['stress', 'cron']
        update_cache: yes
        cache_valid_time: 3600

    - name: Cron job for stress CPU every 30 minutes for 7 minutes
      cron:
        name: Load cpu via stress package
        minute: "*/30"
        job: /usr/bin/stress --cpu 2 --vm 2 --vm-bytes 512M --timeout 420

- name: Install telegraf client on Bastion
  hosts: bastion
  become: true
  vars_files:
  - "./vars/telegraf_dbconnection_vars.yml"
  - "./vars/nginx_telegraf_local.yml"
  roles:
  - role: telegraf-client
    vars:
      telegraf_plugins_base:
      - name: http_listener_v2
        options:
          service_address: "localhost:{{ telegraf_local_port }}"
          data_format: "influx"
  - role: geerlingguy.nginx
    vars:
      nginx_remove_default_vhost: yes
      nginx_vhosts:
      - listen: "80"
        server_name: "localhost"
        extra_parameters: "{{ extra_parameters }}"