---
- name: Build/Check the main infrastructure
  hosts: local
  tasks:
    - include_role:
        name: ecs_node
      vars:
        state: absent
        ecs_name: "{{ hostvars[host_name].name }}"
      loop: "{{ groups['all'] }}"
      loop_control:
        loop_var: host_name
      when: hostvars[host_name].role=="instance" and host_name not in groups['disabled']

    - include_role:
        name: bastion
      vars:
        state: absent
        bastion_name: "{{ hostvars[item].name }}"

      loop: "{{ groups['all'] }}"
      when: hostvars[item].role=="watcher" and item not in groups['disabled']

    - include_role:
        name: public_router
      vars:
        state: absent
        vpc_name: "{{ item }}"
      loop: "{{ vpcs }}"

- name: Delete common container
  hosts: local
  tasks:
    - name: Delete container
      swift_client:
        container: "{{ container_name }}"
        state: absent
